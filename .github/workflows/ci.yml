name: CI
on:
  - push
  - pull_request
jobs:
  build:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.15
      - name: Build
        run: go build -o ./ -v ./...
      - name: Test
        run: go test -v ./...
  tag-new-version:
    runs-on: ubuntu-20.04
    if: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
    outputs:
      current-version: ${{ steps.detect-and-tag-version.outputs.current-version }}
      tag: ${{ steps.detect-and-tag-version.outputs.tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2
      - name: Detect and Tag New Version
        id: detect-and-tag-version
        uses: salsify/action-detect-and-tag-new-version@v2
        with:
          version-command: "grep BuildVersion version.go | cut -d'=' -f 2 | tr -d '\"' | xargs"
